<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="{{ url_for('static', filename='bootstrap.5.1.3.min.css') }}" rel="stylesheet" >
        <style>
            .time {
                font-style: italic;
            }
            .notify {
                display: none;
                color: blue;
                margin-left: 4px;
            }
            .loading {
                color: lightgray;
            }
            .error {
                color: red;
                margin-left: 4px;
            }
            .user {
                padding-bottom: 15px;
                display: block;
            }
            .disabled {
                 border: 1px solid #ddd !important;
                 color: #ccc !important;
             }
            .failed_load {
                height: 62px;
            }
            .h6 { /* user@computer */
              font-size: 0.75rem;
              font-style: italic;
            }
            .btn-outline-primary.no-focus:focus,
            .btn-outline-primary.no-focus:hover,
            .btn-outline-primary.no-focus:active { /* Footer Buttons */
              color: #0d6efd;
              box-shadow: none;
              outline: none;
              background-color: #fff;
            }
            .svg-icon-adjust {
              display: inline-block;
              position: relative;
              top: -2px; /* Move Status Icons 2px upwards */
            }
            .no-gutters > .col,
            .no-gutters > [class*="col-"] {
                padding-right: 0;
                padding-left: 0;
            }
            .no-gutters > .col + .col {
                margin-left: 2px;
            }

            @keyframes blinker {
              50% {
                opacity: 0;
              }
            }

            .status-blink {
              animation: blinker 1.5s linear infinite;
            }

            .time-input {
                color: #0d6efd; /* Setzt die Textfarbe auf Blau */
                border: none; /* Entfernt den Rahmen */
                outline: none; /* Entfernt den Fokus-Rahmen */
                width: auto; /* Setzt die Breite des Eingabefelds auf Auto */
                background: transparent; /* Setzt den Hintergrund auf transparent */
                text-align: center; /* Zentriert den Text im Eingabefeld */
            }

            .time-input:focus,
            .time-input:hover {
                background: transparent; /* Behält den transparenten Hintergrund bei */
                color: #0d6efd; /* Behält die blaue Textfarbe bei */
                outline: none; /* Entfernt den Fokus-Rahmen, falls noch vorhanden */
            }

            /* Optional: Stil für das Eingabefeld, wenn es deaktiviert ist */
            .time-input:disabled {
                color: #0d6efd; /* Setzt die Textfarbe auf Blau */
            }

            /* Stil für den umgebenden div-Container */
            .col-12.btn.btn-outline-primary.disabled.d-flex.justify-content-center {
                justify-content: center; /* Zentriert die Inhalte horizontal */
                display: flex; /* Aktiviert Flexbox */
                flex-direction: row; /* Setzt die Flex-Richtung auf horizontal */
                align-items: center; /* Zentriert die Inhalte vertikal */
            }

            .col-12.btn.btn-outline-primary.disabled.d-flex.justify-content-center:focus,
            .col-12.btn.btn-outline-primary.disabled.d-flex.justify-content-center:hover {
                background: transparent !important; /* Behält den transparenten Hintergrund bei */
            }

            /* ==========================================================================
               Timeline Stuff
               ========================================================================== */

            .timeline {
              display: flex;
              justify-content: space-between;
              margin-top: 5px;
            }

            .time-block {
              display: flex; /* Ermöglicht das Nebeneinanderstellen der inneren Divs */
              flex: 1;
              height: 15px;
              box-sizing: border-box;
              position: relative;
              border-right: 1px solid #b0b3b6; /* Linie zwischen den Stundenblöcken */
            }

            .time-block:last-child {
              border-right: none; /* Keine Linie nach dem letzten Block */
            }

            .time-block > div {
              height: 100%; /* Stellt sicher, dass die Divs die volle Höhe des Elternelements einnehmen */
              border-right: none; /* Entfernt die Linie zwischen den geteilten Divs */
            }

            .time-block:first-child > div:first-child {
                border-top-left-radius: 4px;
                border-bottom-left-radius: 4px;
            }

            .time-block:last-child > div:last-child {
                border-top-right-radius: 4px;
                border-bottom-right-radius: 4px;
            }

            .unlimited,
            .allowed,
            .not-allowed {
              flex-grow: 1; /* Ermöglicht es den Divs, den verfügbaren Platz auszufüllen */
            }

            .unlimited {
              background-color: #0daf5d;
            }

            .allowed {
              background-color: #0d6efd;
            }

            .not-allowed {
              background-color: #e9ecef;
            }

            .current-time-marker {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px; /* Breite des Strichs */
                background-color: #d9534f; /* Farbe des Strichs */
                z-index: 10;
            }

            /* ==========================================================================
               PIN Stuff
               ========================================================================== */

            .accordion-body {
              position: relative;
            }
            .pin-overlay {
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(235, 235, 235, 0.5); /* Semi-transparent Overlay */
              z-index: 10; /* Stellen Sie sicher, dass das Overlay über anderen Inhalten liegt */
            }


            /* ==========================================================================
               Fork Me on Github Stuffs
               ========================================================================== */
            #forkongithub a {
                background:#000;
                color:#ddd;
                text-decoration:none;
                font-family:arial,sans-serif;
                text-align:center;
                font-weight:bold;
                padding:5px 40px;
                transition:0.5s;
                font-size:.8rem;
                line-height: 1rem;
                width:200px;
                position:absolute;
                right: 17px;
                top: 77px;
                transform:rotate(45deg);
                -webkit-transform:rotate(45deg);
                -ms-transform:rotate(45deg);
                -moz-transform:rotate(45deg);
                -o-transform:rotate(45deg);
                box-shadow:4px 4px 10px rgba(0,0,0,0.8);
            }
            #forkongithub a:hover{background:#c11;
                color:#fff;
            }
            #forkongithub a::before,#forkongithub a::after{
                content:"";
                width:100%;
                display:block;
                position:absolute;
                top:1px;
                left:0;
                height:1px;
                background:#fff;
            }
            #forkongithub a::after{
                bottom:1px;
                top:auto;
            }
            #forkongithub {
                position:fixed;
                display:block;
                width:200px;
                overflow:hidden;
                height:200px;
                z-index:9999;
                right: -55px;
                top: -30px;
            }
            @media only screen and (max-width: 600px) {
                #forkongithub {
                    width: 173px;
                    height: 150px;
                }
                #forkongithub a {
                    font-size: 0.6rem;
                    line-height: .3rem;
                    right: -13px;
                    top: 57px;
                }
            }

            /* ==========================================================================
               Theme Stuffs
               ========================================================================== */
            .dark-mode {
              background-color: black;
              color: white;
            }
            .dark-mode #forkongithub a {
              background:#fff;
              color:#000;
              box-shadow:4px 4px 10px rgba(255,255,255,0.8);
            }
            .dark-mode #forkongithub a:hover{background:#c11;
              color:#000;
            }
            .dark-mode #forkongithub a::before,.dark-mode #forkongithub a::after{
              background:#000;
            }
            .dark-mode .btn-outline-primary {
              color: #fff;
              background-color: #96baff;
              border-color: #708ad9;
            }
            .dark-mode .btn-outline-primary:hover {
              background-color: #96baff;
              border-color: #708ad9;
            }
            .btn-check:checked + .btn-outline-primary {
              background-color: #7585b5;
            }
            .dark-mode .btn-outline-primary:hover, .dark-mode .notify {
              color: #4d67b5;
            }
            .dark-mode .fs-1 {
              color: #7385cc;
            }
            .dark-mode .error {
              color: #ffe140;
            }
            .dark-mode .btn-group .disabled  {
              border: 1px solid darkblue !important;
              color: #fdf5f6 !important;
              background-color: darkgray;
            }
            .dark-mode .accordion {
              background-color: transparent;
              color: #7385cc;
            }
            .dark-mode .accordion-item {
              background-color: transparent; /* Dunklerer Hintergrund für jedes Accordion-Item */
              border-color: transparent; /* Dunklere Grenzen für ein besseres Kontrastverhältnis */
            }

            .dark-mode .accordion-button {
              background-color: transparent;
              color: #fdf5f6; /* Helle Schriftfarbe für den Accordion-Button im Dark Mode */
            }
            .dark-mode .accordion-button:not(.collapsed)::after {
              background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
            }
            .dark-mode .accordion-button::after {
              background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
            }
            .dark-mode .progress {
              background-color: darkgrey;
            }
            .dark-mode .form-control {
              background-color: #555;
              color: #eee;
              border: 1px solid #666;
            }
            .dark-mode .btn-primary {
              background-color: #0d6efd;
              border-color: #0a58ca;
              color: #fff;
            }
            .dark-mode .btn-close {
              filter: invert(1);
            }
            .dark-mode #pinError {
              color: #ff6b6b;
            }

            /* ==========================================================================
            Accordions
            ========================================================================== */
            .accordion-item {
              border: none;
            }

            .accordion-button:not(.collapsed) {
              border: none;
              box-shadow: none;
              text-align: left;
              background-color: transparent;
              padding-top: 0;
              padding-left: 0;
              padding-bottom: 0;
              margin-bottom: 0;
            }

            .accordion-button.collapsed {
              border: none;
              box-shadow: none;
              text-align: left;
              padding-top: 0;
              padding-left: 0;
              padding-bottom: 0;
              margin-bottom: 0;
            }

            .accordion-header h2 {
              font-size: 0.9rem;
              margin-bottom: 0;
            }
        
        </style>

    <title>
        Timekpr Next Remote
    </title>

  </head>
  <body class="">
    <!-- thanks https://codepo8.github.io/css-fork-on-github-ribbon/ ! -->
    <span id="forkongithub" class="hidden-print ">
        <a href="https://github.com/mrjones-plip/timekpr-next-remote">Fork me on GitHub</a>
    </span>
<div class="container-sm">

  <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
    <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
    <span class="fs-1">Timekpr Next Remote
    </span>
    </a>
  </header>

  <div class="b-example-divider"></div>

  <!-- Menu Area -->

  <!--<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Home</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">History</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="database-tab" data-toggle="tab" href="#database" role="tab" aria-controls="database" aria-selected="false">Database</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="config-tab" data-toggle="tab" href="#config" role="tab" aria-controls="config" aria-selected="false">Config</a>
    </li>
  </ul>-->


  <div class="tab-content" id="myTabContent">
    <!-- Main Area -->
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
      <br>
      <div id='messageDisplay'></div> <!-- Status Message -->
      <div class='accordion' id='accordion'>
        <div id="people"></div> <!-- Populated by script -->
      </div>
    </div>

  <!-- History Tab Pane -->
  <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
    <br>
    {% if database.time_changes %}
      {% set history_data = namespace(data={}) %}
      <!-- Organize data by computer_user -->
      {% for key, value in database.time_changes.items() %}
        {% set parts = key.split('_') %}
        {% set computer_user = parts[0] ~ '_' ~ parts[1] %}
        {% if computer_user not in history_data.data %}
          {% set _dummy = history_data.data.update({computer_user: []}) %}
        {% endif %}
        {% set details = value.split(',') %}
        {% set _dummy = history_data.data[computer_user].append({
          'action': details[0],
          'seconds': details[1],
          'timeframe': details[2],
          'status': details[3],
          'timestamp': parts[2]
        }) %}
      {% endfor %}

      <!-- Create a table for each computer_user -->
      {% for computer_user, changes in history_data.data.items() %}
        <h3>{{ computer_user.replace('_', ' - ') }}</h3>
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th scope="col">Timestamp</th>
              <th scope="col">Action</th>
              <th scope="col">Seconds</th>
              <th scope="col">Timeframe</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            {% if changes %}
              {% for change in changes %}
                <tr>
                  <td>{{ change.timestamp | format_timestamp }}</td>
                  <td>{{ change.action }}</td>
                  <td>{{ change.seconds }}</td>
                  <td>{{ change.timeframe }}</td>
                  <td>{{ change.status }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" class="text-center">Empty</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      {% endfor %}
    {% else %}
      <p>No time changes yet.</p>
    {% endif %}
  </div>

    <!-- Database Area -->
    <div class="tab-pane fade" id="database" role="tabpanel" aria-labelledby="database-tab">
      <div>
          <h1>Settings Overview</h1>
          {% for section, settings in database.items() %}
          <!-- Add Bootstrap classes to the table element -->
          <table class="table table-bordered table-hover">
              <thead class="thead-dark"> <!-- You can use the class "thead-light" for a light header -->
                  <tr>
                      <th colspan="2">{{ section }}</th>
                  </tr>
                  <tr>
                      <th>Key</th>
                      <th>Value</th>
                  </tr>
              </thead>
              <tbody>
                  {% for key, value in settings.items() %}
                  <tr>
                      <td>{{ key }}</td>
                      <td>{{ value }}</td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
          {% endfor %}
      </div>
    </div>

    <!-- Config Area -->
    <!-- Take care: variables are case-senstive!-->
    <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">
      <br>
    <!--  <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="background_service" name="background_service" {% if database['settings']['background_service'] == 'true' %}checked{% endif %} onchange="updateSetting('background_service', this.checked ? 'true' : 'false')">
        <label class="form-check-label" for="background_service">Background Service</label>
      </div> -->
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="show_time_change" name="show_time_change" {% if database['settings']['show_time_change'] == 'true' %}checked{% endif %} onchange="updateSetting('show_time_change', this.checked ? 'true' : 'false')">
        <label class="form-check-label" for="show_time_change">Show Time Change</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="Option2" name="Option3" {% if database['settings']['option3'] == 'true' %}checked{% endif %} onchange="updateSetting('option3', this.checked ? 'true' : 'false')">
        <label class="form-check-label" for="Option2">Option 3</label>
      </div>
    </div>
  </div>



  <!-- Footer  Area -->
  <div>
    <label class="btn btn-outline-primary no-focus" id="toggle_theme">Toggle Theme</label>
    <label class="btn btn-outline-primary no-focus" id="auto_update">Auto Update: <span id="status-background_service" class="svg-icon-adjust"><!-- Updated by script --></span></label>
    <label class="btn btn-outline-primary no-focus" id="pin_status">PIN: <span id="pin_status_icon" class="svg-icon-adjust"><!-- Updated by script --></span></label>
    <label class="btn btn-outline-primary no-focus" id="countdown_label"><span id="countdown_timer">30</span></label>
  </div>

</div>

  <!-- Script  Area -->
    <script src="{{ url_for('static', filename='bootstrap.5.1.3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='jquery-3.6.3.min.js') }}"></script>
    <script>
        var isPinRequired = false;
        var isPinVerified = false;
        var verifiedPin = null;
        var allUsers = [];
        $.getJSON( "/config", function( data ) {
            isPinRequired = data.pin_required;
            updatePinStatusIcon();
            updatePinStatusLabelClickable();
            updateBackgroundStatusIcon();
            updateAutoUpdateButtonClickable();
            $.each( data.trackme, function( computer, userArrays ) {
                $.each(userArrays, function(index, userArray) {
                    let rand_dom = '_' + uuidv4();
                    let user = userArray[0];
                    let display_name = userArray[1];
                    allUsers.push({
                        computer: computer,
                        user: user,
                        rand_dom: rand_dom,
                        display_name: display_name
                    });
                    // todo - click doesn't work and radio spans accross users'

                    // Append user elements to the 'people' container
                    $("#people").append(
                        "<span class='user' id='" + user + rand_dom + "'>" +
                          "<div class='accordion-item'>" +
                              "<h2 class='accordion-header' id='heading" + rand_dom + "'>" +
                                  "<button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#collapse" + rand_dom + "' aria-expanded='false' aria-controls='collapse" + rand_dom + "'>" +
                                    "<span class='h3'>" + display_name + "<span class='notify loading'></span></span>" +
                                  "</button>" +
                              "</h2>" +
                              "<div class='user-progress' data-toggle-target='#collapse" + rand_dom + "'>" +
                                "<p class='h6'>[" + user + "@" + computer + "] - [<span class='status'>Unknown</span>]<span class='lastRelevantChange'></span></p>" +

                                "<div class='timeline-wrapper' style='display: none;'>" +
                                "</div>" +

                                "<div class='monthly-wrapper' style='display: none;'>" +
                                  "Monthly Limit: <span class='time month_total'>...</span><br/>" +
                                  "<div class='progress'>" +
                                      "<div class='progress-bar overflow-visible month_left' role='progressbar' style='width: 0%' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100'>month_left</div>" +
                                  "</div>" +

                                "</div>" +
                                "<div class='weekly-wrapper' style='display: none;'>" +
                                  "Weekly Limit: <span class='time week_total'>...</span><br/>" +
                                  "<div class='progress'>" +
                                      "<div class='progress-bar overflow-visible week_left' role='progressbar' style='width: 0%' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100'>week_left</div>" +
                                  "</div>" +
                                "</div>" +

                                "<div class='daily-wrapper' style='display: none;'>" +
                                  "Daily Limit: <span class='time time_total'>...</span><br/>" +
                                  "<div class='progress'>" +
                                      "<div class='progress-bar overflow-visible time_left' role='progressbar' style='width: 0%' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100'>time_left</div>" +
                                  "</div>" +
                                "</div>" +

                                "<div class='playtime-wrapper' style='display: none;'>" +
                                    "Playtime Limit: <span class='time playtime_total'>...</span><br/>" +
                                    "<div class='progress'>" +
                                        "<div class='progress-bar bg-warning overflow-visible playtime_left' role='progressbar' style='width: 0%' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100'>playtime_left</div>" +
                                    "</div>" +
                                "</div>" +
                                "Last seen: <span class='time last_seen'>...</span>" +
                            "</div>" +

                            "<div id='collapse" + rand_dom + "' class='accordion-collapse collapse' aria-labelledby='heading" + rand_dom + "' data-bs-parent='#accordion'>" +
                              "<div class='accordion-body  position-relative'>" +

                                "<div class='row no-gutters mb-2' role='group' aria-label='Action'>" +
                                    "<div class='col-6'>" +
                                        "<input type='radio' class='btn-check' id='add" + rand_dom + "' value='add' name='action' disabled />" +
                                        "<label class='btn btn-outline-primary w-100 disabled' for='add" + rand_dom + "'>Add</label>" +
                                    "</div>" +
                                    "<div class='col-6'>" +
                                        "<input type='radio' class='btn-check' id='remove" + rand_dom + "' value='remove' name='action' disabled />" +
                                        "<label class='btn btn-outline-primary w-100 disabled' for='remove" + rand_dom + "'>Remove</label>" +
                                    "</div>" +
                                "</div>" +

                                "<div class='row no-gutters mb-2' role='group' aria-label='Timeframe'>" +
                                    "<div class='col daily-wrapper px-0'>" +
                                        "<input type='radio' class='btn-check' id='daily" + rand_dom + "' value='daily' name='timeframe' disabled />" +
                                        "<label class='btn btn-outline-primary w-100 disabled' for='daily" + rand_dom + "'>Daily</label>" +
                                    "</div>" +
                                    "<div class='col weekly-wrapper px-0'>" +
                                        "<input type='radio' class='btn-check' id='weekly" + rand_dom + "' value='weekly' name='timeframe' disabled />" +
                                        "<label class='btn btn-outline-primary w-100 disabled' for='weekly" + rand_dom + "'>Weekly</label>" +
                                    "</div>" +
                                    "<div class='col monthly-wrapper px-0'>" +
                                        "<input type='radio' class='btn-check' id='monthly" + rand_dom + "' value='monthly' name='timeframe' disabled />" +
                                        "<label class='btn btn-outline-primary w-100 disabled' for='monthly" + rand_dom + "'>Monthly</label>" +
                                    "</div>" +
                                    "<div class='col playtime-wrapper px-0'>" +
                                        "<input type='radio' class='btn-check' id='playtime" + rand_dom + "' value='playtime' name='timeframe' disabled />" +
                                        "<label class='btn btn-outline-primary w-100 disabled' for='playtime" + rand_dom + "'>Playtime</label>" +
                                    "</div>" +
                                "</div>" +

                                "<div class='row no-gutters mb-2' role='group' aria-label='Time Slider'>" +
                                    "<div class='col-12 btn btn-outline-primary disabled d-flex justify-content-center'>" +
                                      "<input type='number' id='time-value" + rand_dom + "' class='form-range time-input' placeholder='15' min='0' oninput='validateAndUpdateTimeValue(this, \"" + rand_dom + "\")' disabled />" +
                                    "</div>" +
                                    "<div class='col-12 btn btn-outline-primary disabled mt-2'>" +
                                        "<input type='range' class='form-range w-100 disabled' id='seconds" + rand_dom + "' name='seconds' min='60' max='3600' step='60' value='900' oninput='updateSliderValue(this.value, \"" + rand_dom + "\")' disabled />" +
                                    "</div>" +
                                "</div>" +

                                "<div class='row no-gutters mb-2' role='group' aria-label='save'>" +
                                    "<div class='col-12'>" +
                                        "<button class='btn btn-outline-primary w-100 save_me disabled' value='save' user='" + user + "' computer='" + computer + "' disabled >Save</button>" +
                                    "</div>" +
                                "</div>" +

                                "<div class='pin-overlay position-absolute w-100 h-100' id='pinOverlay" + rand_dom + "' style='top: 0; left: 0; display: none;'>" +
                                  "<div class='pin-container d-flex justify-content-center align-items-center h-100'>" +  
                                    "<div class='text-center'>" +
                                      "<form class='form-inline' id='pinForm" + rand_dom + "'>" +
                                        "<div class='form-group mb-2'>" +
                                          "<label for='pinInput" + rand_dom + "' class='sr-only'>Enter PIN:</label>" +
                                          "<input type='password' class='form-control' id='pinInput" + rand_dom + "' placeholder='Enter PIN'>" +  
                                        "</div>" +
                                        "<button type='submit' class='btn btn-primary mb-2 submit-button'>Submit</button>" +
                                      "</form>" +
                                      "<div class='alert alert-danger mt-2 d-none' role='alert'></div>" +
                                    "</div>" +
                                  "</div>" +
                                "</div>" +

                                /*"<div class='card btn-group' id='time-change-card-" + user + rand_dom + "'>" +
                                  "<div class='card-header'>" +
                                      "Time Change History [last 10]" +
                                  "</div>" +
                                    "<ul class='list-group list-group-flush p-1' id='time-change-list-" + user + rand_dom + "'>" +
                                        // Populated by script
                                    "</ul>" +
                                "</div>" +*/
                              "</div>" +
                            "</div>" +
                          "</div>" +
                        "</span>"
                    );
                    $("#people").append("<hr />"); // add horizontal line between users

                    // Show loading message and disable buttons
                    $('#' + user  + rand_dom + " .notify").show().html("Loading...");

                    // Start loading animation
                    var loadingInterval = setInterval(function() {
                        $('#' + user + rand_dom + " .loading").fadeIn(1300).fadeOut(1300);
                    }, 1400);

                    // Load user data
                    $.getJSON("/get_database/" + computer + "/" + user, function(usage) {
                        // Data has been loaded, stop the loading animation
                        clearInterval(loadingInterval);
                        // Hide the loading element
                        $('#' + user + rand_dom + " .loading").stop(true, true).hide();

                        // Disable Buttons until first succesfull connection
                        if (usage.last_seen !== "Never" && isBackgroundServiceEnabled) {
                            $('#' + user + rand_dom + ' .btn').removeClass("disabled").prop('disabled', false);
                            $('#' + user + rand_dom + ' .btn-check').removeClass("disabled").prop('disabled', false);
                            $('#' + user + rand_dom + ' .form-range').removeClass("disabled").prop('disabled', false);
                        }
                        // If Background Service is disabled activate buttons only if user is online
                        if (usage.last_seen !== "Never" && usage.online_status === 'Online') {
                            $('#' + user + rand_dom + ' .btn').removeClass("disabled").prop('disabled', false);
                            $('#' + user + rand_dom + ' .btn-check').removeClass("disabled").prop('disabled', false);
                            $('#' + user + rand_dom + ' .form-range').removeClass("disabled").prop('disabled', false);
                        }
                        render_user_to_dom(user, computer, usage, rand_dom);
                        add_click_handler(user, rand_dom);

                        if (isPinRequired && !isPinVerified) {
                            // Show the PIN overlay for this specific user
                            $('#pinOverlay' + rand_dom).show();
                        }
                    }).fail(function() {
                        // If there's an error loading the data, stop the loading animation
                        clearInterval(loadingInterval);
                        $('#' + user + rand_dom + " .notify").html("Error loading data.");
                    });
                });
            });
            $("#people").on("click", ".user-progress", function() {
                var collapseTarget = $(this).data("toggle-target");
                $(collapseTarget).collapse('toggle');
            });
        });

        function reloadAllUserData() {
            allUsers.forEach(function(userObj) {
                loadUserData(userObj.user, userObj.computer, userObj.rand_dom);
            });
        }

        function loadUserData(user, computer, rand_dom) {
            // Show loading message and disable buttons
            $('#' + user + rand_dom + " .notify").show().html("Loading...");

            // Start loading animation
            var loadingInterval = setInterval(function() {
                $('#' + user + rand_dom + " .loading").fadeIn(1300).fadeOut(1300);
            }, 1400);

            // Load user data
            $.getJSON("/get_database/" + computer + "/" + user, function(usage) {
                // Data has been loaded, stop the loading animation
                clearInterval(loadingInterval);
                // Hide the loading element
                $('#' + user + rand_dom + " .loading").stop(true, true).hide();

                // Render user data to the DOM
                render_user_to_dom(user, computer, usage, rand_dom);

            }).fail(function() {
                // If there's an error loading the data, stop the loading animation
                clearInterval(loadingInterval);
                $('#' + user + rand_dom + " .notify").html("Error loading data.");
            });
        }

        // For Slider Input
        function updateSliderValue(seconds, rand_dom) {
            var minutes = Math.floor(seconds / 60);
            document.getElementById('time-value' + rand_dom).value = minutes;
        }

        // For manual Input
        function validateAndUpdateTimeValue(input, rand_dom) {
            var minutes = parseInt(input.value, 10);
            if (isNaN(minutes) || minutes < 0) {
                input.value = 0;  // Invalid or negative values will be set to 0
                minutes = 0;
            }
            var seconds = minutes * 60;
            document.getElementById('seconds' + rand_dom).value = seconds;
        }

        function uuidv4() {
            return 'xxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function add_click_handler(user, rand_dom) {
            $("#" + user + rand_dom + " .save_me").off('click').click(function() {
                const computer = $(this).attr('computer');
                const action = $('#' + user + rand_dom + ' input[name="action"]:checked').val();
                const timeframe = $('#' + user + rand_dom + ' input[name="timeframe"]:checked').val();
                const seconds = $('#' + user + rand_dom + ' input[name="seconds"]').val();
                
                console.log("Attempting to save: ", {user, computer, action, seconds, timeframe}); // Debug
                if (action !== undefined && seconds !== undefined && timeframe !== undefined) {
                    $('input').prop('checked', false);
                    $('#' + user  + rand_dom + " .notify").show().html("Transmitting...");
                    add_or_remove_time(user, computer, action, seconds, timeframe, rand_dom, function(message) {
                        // Update the .notify element with the message from the callback
                        $('#' + user + rand_dom + ' .notify').html(message).fadeIn(function() {
                            setTimeout(function() {
                                $('#' + user + rand_dom + ' .notify').fadeOut("slow");
                            }, 1000);
                        });
                    });
                    // Collapse accordion
                    $('#collapse' + rand_dom).collapse('hide');
                } else {
                    alert("Choose 'Add' or 'Remove', a timeframe, and an amount of time to add.");
                }
            });
        }

        function createTimelineHtml(allowedHoursString) {
            const allowedHoursArray = allowedHoursString.split(';');
            const currentHour = new Date().getHours();
            const currentMinute = new Date().getMinutes();
            let timelineHtml = '<div class="timeline">';

            // Initialize all hours as not allowed
            let hourStatus = new Array(24).fill('not-allowed');

            // Parse the allowed hours string and update the hourStatus array
            allowedHoursArray.forEach(timeSpec => {
                if (timeSpec.includes('[')) {
                    // Specific allowed range within an hour
                    const hour = parseInt(timeSpec);
                    const range = timeSpec.match(/\[(\d+)-(\d+)\]/);
                    if (range) {
                        const start = parseInt(range[1], 10);
                        const end = parseInt(range[2], 10);
                        hourStatus[hour] = { type: 'range', start: start, end: end };
                    }
                } else if (timeSpec.startsWith('!')) {
                    // Unlimited hours
                    const hour = parseInt(timeSpec.substring(1));
                    hourStatus[hour] = 'unlimited';
                } else {
                    // Entire hour allowed
                    const hour = parseInt(timeSpec);
                    hourStatus[hour] = 'allowed';
                }
            });

            for (let hour = 0; hour < 24; hour++) {
                // Construct the time block div(s)
                timelineHtml += `<div class='time-block' data-hour='${hour}'>`;

                const status = hourStatus[hour];
                if (status === 'unlimited') {
                    timelineHtml += `<div class='unlimited' style='flex: 1;'></div>`;
                } else if (status === 'allowed') {
                    timelineHtml += `<div class='allowed' style='flex: 1;'></div>`;
                } else if (typeof status === 'object' && status.type === 'range') {
                    const notAllowedWidthStart = (status.start / 60) * 100;
                    const allowedWidth = ((status.end - status.start) / 60) * 100;
                    if (notAllowedWidthStart > 0) {
                        timelineHtml += `<div class='not-allowed' style='flex: ${notAllowedWidthStart};'></div>`;
                    }
                    timelineHtml += `<div class='allowed' style='flex: ${allowedWidth};'></div>`;
                    if (notAllowedWidthStart + allowedWidth < 100) {
                        timelineHtml += `<div class='not-allowed' style='flex: ${100 - notAllowedWidthStart - allowedWidth};'></div>`;
                    }
                } else {
                    // Hour is not allowed
                    timelineHtml += `<div class='not-allowed' style='flex: 1;'></div>`;
                }

                // Add the current time marker if it's the current hour
                if (hour === currentHour) {
                    const minutePercent = (currentMinute / 60) * 100;
                    timelineHtml += `<div class='current-time-marker' style='left: ${minutePercent}%'></div>`;
                }

                // Close the time block div
                timelineHtml += `</div>`;
            }

            timelineHtml += '</div>';
            return timelineHtml;
        }

        function render_user_to_dom(user, computer, usage, rand_dom){
            if(usage.result === 'success') {
                // Success Notification
                $( '#' + user + rand_dom + ' .notify').fadeOut().html('Loaded!').fadeIn(function() {
                    setTimeout(function() {
                        $('#' + user + rand_dom + ' .notify').fadeOut("slow");
                    }, 1000);
                });

                // Show only necessary data
                var currentDate = new Date();
                var currentYear = currentDate.getFullYear();
                var currentMonth = currentDate.getMonth();
                var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                var secondsInMonth = daysInMonth * 24 * 60 * 60; // Calculate maximum seconds of current month

                var showWeekly = usage.week_limit < 604800; // show weekly if there is a limit smaller than maximum seconds per week
                var showMonthly = usage.month_limit < secondsInMonth; // show monthly if there is a limit smaller than maximum seconds per month
                var showPlaytime = usage.playtime_enabled === true && usage.playtime_limit_override_enabled !== true; // show playtime if enabled and not overriden

                $('#' + user + rand_dom + " .daily-wrapper").slideDown(); // always show daily
                $('#' + user + rand_dom + " .timeline-wrapper").slideDown(); // always show timeline

                if (showWeekly) {
                    $('#' + user + rand_dom + " .weekly-wrapper").slideDown();
                    $('label[for="weekly' + rand_dom + '"]').show();
                } else {
                    $('#' + user + rand_dom + " .weekly-wrapper").slideUp(); // hide progressbar
                    $('label[for="weekly' + rand_dom + '"]').hide(); // hide formular button
                }

                if (showMonthly) {
                    $('#' + user + rand_dom + " .monthly-wrapper").slideDown();
                    $('label[for="monthly' + rand_dom + '"]').show();
                } else {
                    $('#' + user + rand_dom + " .monthly-wrapper").slideUp(); // hide progressbar
                    $('label[for="monthly' + rand_dom + '"]').hide(); // hide formular button
                }

                if (showPlaytime) {
                    $('#' + user + rand_dom + " .playtime-wrapper").slideDown();
                    $('label[for="playtime' + rand_dom + '"]').show();
                } else {
                    $('#' + user + rand_dom + " .playtime-wrapper").slideUp(); // hide progressbar
                    $('label[for="playtime' + rand_dom + '"]').hide(); // hide formular button
                }

                if (!showWeekly && !showMonthly && !showPlaytime) {
                    // Hide daily as well if no other button has to be shown
                    $('label[for="daily' + rand_dom + '"]').hide();
                    $('#daily' + rand_dom).prop('checked', true); // always send daily in this case
                } else {
                    $('label[for="daily' + rand_dom + '"]').show();
                }

                // Update the timeline
                const allowedHoursString = "7;8;9;10;11[00-30];!14;!15;17;18;19;20[00-45]";
                const timelineHtml = createTimelineHtml(allowedHoursString);
                $('#' + user + rand_dom + ' .timeline-wrapper').html(timelineHtml);

                // Show updated limits even if "last seen" is older than yesterday/last week/last month
                var timestampStr = usage.timestamp;
                var timestampParts = timestampStr.split(/[- :.]/); // Split by the separators
                var timestampDate = new Date(
                    parseInt(timestampParts[0], 10), // year
                    parseInt(timestampParts[1], 10) - 1, // month (0-based index)
                    parseInt(timestampParts[2], 10), // day
                    parseInt(timestampParts[3], 10), // hours
                    parseInt(timestampParts[4], 10), // minutes
                    parseInt(timestampParts[5], 10) // seconds (we ignore the fractional part)
                );

                var currentDate = new Date();
                var beginningOfCurrentDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                beginningOfCurrentDay.setHours(0, 0, 0, 0); // Set to the beginning of the current day
                var lastMonday = new Date(currentDate);
                lastMonday.setDate(currentDate.getDate() - (currentDate.getDay() || 7) + 1);
                lastMonday.setHours(0, 0, 0, 0); // Set to the beginning of last Monday
                var firstDayOfCurrentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                firstDayOfCurrentMonth.setHours(0, 0, 0, 0); // Set to the beginning of the current month

                // Check if the timestamp is from yesterday or before
                var isFromYesterdayOrBefore = timestampDate < beginningOfCurrentDay;
                // Check if the timestamp is from last week or before
                var isFromLastWeekOrBefore = timestampDate < lastMonday;
                // Check if the timestamp is from last month or before
                var isFromLastMonthOrBefore = timestampDate < firstDayOfCurrentMonth;

                var dayOfWeekIndex = currentDate.getDay() - 1; // In JavaScript, getDay() returns 0 for Sunday, so we adjust it for Monday as the first day
                if (dayOfWeekIndex === -1) dayOfWeekIndex = 6; // Adjust Sunday to be the last index

                // Get the time limit for the current day of the week from the time_total array
                var timeTotalForToday = usage.time_total.length > dayOfWeekIndex ? usage.time_total[dayOfWeekIndex] : 0;
                // Get the playtime limit for the current day of the week from the playtime_total array
                var playtimeTotalForToday = usage.playtime_total.length > dayOfWeekIndex ? usage.playtime_total[dayOfWeekIndex] : 0;

                // actualTimeTotal can be smaller than timeTotalForToday if weekly/monthly limits are in place
                var actualTimeTotal = usage.actual_time_left + usage.actual_time_spent;

                // Update the calculation for timeTotal and playtimeTotal
                var timeTotal = Math.min(timeTotalForToday, actualTimeTotal);
                var playtimeTotal = playtimeTotalForToday;

                // Determine the .time_left value based on the timestamp
                var timeLeftToShow = isFromYesterdayOrBefore ? Math.min(timeTotal, usage.week_left, usage.month_left) : usage.actual_time_left;
                // Determine the .playtime_left value based on the timestamp
                var playtimeLeftToShow = isFromYesterdayOrBefore ? playtimeTotal : usage.actual_playtime_left;
                // Determine the .week_left value based on the timestamp
                var weekLeftToShow = isFromLastWeekOrBefore ? usage.week_limit : usage.week_left;
                // Determine the .month_left value based on the timestamp
                var monthLeftToShow = isFromLastMonthOrBefore ? usage.month_limit : usage.month_left;

                // Calculation for ProgressBars
                var timeSpentPercent = (timeLeftToShow / timeTotal) * 100;
                var playtimeSpentPercent = (playtimeLeftToShow / playtimeTotal) * 100;
                var weekSpentPercent = (weekLeftToShow / usage.week_limit) * 100;
                var monthSpentPercent = (monthLeftToShow / usage.month_limit) * 100;

                // Update Progress Bar for time left
                $('#' + user + rand_dom + " .progress-bar.time_left")
                    .css('width', timeSpentPercent + '%')
                    .attr('aria-valuenow', timeSpentPercent)
                    .html(secondsToHms(timeLeftToShow) + ' (' + timeSpentPercent.toFixed(2) + '%)');

                // Update Progress Bar for playtime left
                $('#' + user + rand_dom + " .progress-bar.playtime_left")
                    .css('width', playtimeSpentPercent + '%')
                    .attr('aria-valuenow', playtimeSpentPercent)
                    .html(secondsToHms(playtimeLeftToShow) + ' (' + playtimeSpentPercent.toFixed(2) + '%)');

                // Update Progress Bar for week left
                $('#' + user + rand_dom + " .progress-bar.week_left")
                    .css('width', weekSpentPercent + '%')
                    .attr('aria-valuenow', weekSpentPercent)
                    .html(secondsToHms(weekLeftToShow) + ' (' + weekSpentPercent.toFixed(2) + '%)');

                // Update Progress Bar for month left
                $('#' + user + rand_dom + " .progress-bar.month_left")
                    .css('width', monthSpentPercent + '%')
                    .attr('aria-valuenow', monthSpentPercent)
                    .html(secondsToHms(monthLeftToShow) + ' (' + monthSpentPercent.toFixed(2) + '%)');

                // Update other values
                $('#' + user + rand_dom + " .timestamp").html(usage.timestamp);
                $('#' + user + rand_dom + " .last_seen").html(usage.last_seen);
                $('#' + user + rand_dom + " .time_left").html(secondsToHms(timeLeftToShow));
                $('#' + user + rand_dom + " .time_total").html(secondsToHms(timeTotal));
                $('#' + user + rand_dom + " .playtime_left").html(secondsToHms(playtimeLeftToShow));
                $('#' + user + rand_dom + " .playtime_total").html(secondsToHms(playtimeTotal));
                $('#' + user + rand_dom + " .week_left").html(secondsToHms(weekLeftToShow));
                $('#' + user + rand_dom + " .week_total").html(secondsToHms(usage.week_limit));
                $('#' + user + rand_dom + " .month_left").html(secondsToHms(monthLeftToShow));
                $('#' + user + rand_dom + " .month_total").html(secondsToHms(usage.month_limit));

                // Animate Progress Bar when Online
                var statusElement = $('#' + user + rand_dom + " .status");
                var allProgressBars = $('#' + user + rand_dom + " .progress-bar");
                if (usage.online_status === 'Online') {
                    statusElement.text('Online').css('color', 'green');
                    allProgressBars.addClass('progress-bar-striped progress-bar-animated');
                } else {
                    statusElement.text('Offline').css('color', '#8B0000');
                    allProgressBars.removeClass('progress-bar-striped progress-bar-animated');
                }

                // Remove "Loading"
                $('#' + user + rand_dom + " .loading").removeClass('loading');
                
                // Check if time_changes data is available and render it
                var timeChangeListHtml = '';
                var lastRelevantChangeHtml = '';

                if(usage.time_changes && Object.keys(usage.time_changes).length > 0) {
                    // Create an array from the keys of time_changes
                    var changesArray = Object.keys(usage.time_changes).map(function(key) {
                        var timestamp = key.split('_').pop();
                        var details = parseChangeDetails(usage.time_changes[key]);
                        return {
                            timestamp: timestamp,
                            action: details.action,
                            minutes: details.minutes,
                            timeframe: details.timeframe,
                            status: details.status
                        };
                    });

                    // Sort the array based on the timestamp in descending order
                    changesArray.sort(function(a, b) {
                        return b.timestamp.localeCompare(a.timestamp);
                    });

                    // Find the last relevant change with a status other than 'success'
                    var lastRelevantChange = usage.time_changes && Object.values(usage.time_changes).find(function(change) {
                        var details = parseChangeDetails(change);
                        return details.status.toLowerCase() === 'pending';
                    });

                    // If a relevant change is found, create the HTML for it
                    if (lastRelevantChange) {
                        var details = parseChangeDetails(lastRelevantChange);
                        var lastRelevantChangeHtml = ` ${details.action} ${details.minutes} mins (${details.timeframe}) - <span class='status-blink'>${details.status}</span>`;
                        $('#' + user + rand_dom + ' .lastRelevantChange').html(lastRelevantChangeHtml);
                    }

                    // Build the HTML list with the sorted entries
                    changesArray.forEach(function(change) {
                        var listItem = `<li class='list-group-item'>${change.action} ${change.minutes} mins (${change.timeframe}) - ${change.status}</li>`;
                        timeChangeListHtml += listItem;
                    });
                } else {
                    // If there are no time changes, display a message
                    timeChangeListHtml = "<li class='list-group-item'>No time changes yet</li>";
                }
                  // Append the time change history to the corresponding list in the HTML
                $('#time-change-list-' + user + rand_dom).html(timeChangeListHtml);

                // Warnin message in case there are pending time changes
                var warningMessageContainer = $('#' + user + rand_dom + " .warning-message");
                if(lastRelevantChange) {
                    var warningMessage = "<div class='warning-message' style='color: red; text-align: center;'>! Current pending time change will be cancelled !</div>";
                    if(warningMessageContainer.length === 0) {
                        $('#' + user + rand_dom + " .save_me").after(warningMessage);
                    }
                } else {
                    warningMessageContainer.remove();
                }

            } else {
                // Error Notification
                $('#' + user + rand_dom + " .time_wrapper").html(computer + " failed. Off? Bad Auth?");
                $('#' + user + rand_dom + " .notify").addClass("error").html("Error");
            }
        }

        // #### PIN Section START ####

        // Function to verify the PIN on the server
        function verifyPin(pinInputId, pinOverlayId) {
            const enteredPin = $('#' + pinInputId).val();
            $.ajax({
                type: 'POST',
                url: '/verify_pin',
                data: { pin: enteredPin },
                success: function(data) {
                    if (data.result === "success") {
                        isPinVerified = true;
                        verifiedPin = enteredPin;
                        updatePinStatusIcon();
                        updateBackgroundStatusIcon();
                        updateAutoUpdateButtonClickable();

                        // Remove all Overlays when successfull
                        $('.pin-overlay').hide();

                        // Activate buttons
                        $('.btn').removeClass("disabled").prop('disabled', false);
                        $('.btn-check').removeClass("disabled").prop('disabled', false);
                        $('.form-range').removeClass("disabled").prop('disabled', false);
                    } else {
                        $('#' + pinInputId).siblings('.alert-danger').text('Incorrect PIN').removeClass('d-none').show();
                    }
                },
                error: function(xhr) {
                    $('#' + pinInputId).siblings('.alert-danger').text('An error occurred while verifying the PIN.').removeClass('d-none').show();
                }
            });
            $('#' + pinInputId).val('');
        }

        $(document).ready(function() {
            // Event listener for all submit buttons of the PIN forms
            $(document).on('submit', 'form[id^="pinForm"]', function(event) {
                event.preventDefault(); // Prevent the default form submit behavior
                var formId = $(this).attr('id');
                var pinInputId = 'pinInput' + formId.replace('pinForm', '');
                var pinOverlayId = 'pinOverlay' + formId.replace('pinForm', '');
                verifyPin(pinInputId, pinOverlayId);
            });

            // Event listener for pressing the Enter key in all PIN input fields
            $(document).on('keypress', 'input[id^="pinInput"]', function(event) {
                if (event.which === 13) { // 13 is the keycode for the Enter key
                    event.preventDefault(); // Prevent the default form submit behavior
                    var pinInputId = $(this).attr('id');
                    var pinOverlayId = 'pinOverlay' + pinInputId.replace('pinInput', '');
                    verifyPin(pinInputId, pinOverlayId);
                }
            });

            // Event listener for accordion open (shown.bs.collapse)
            // This will apply to all accordion items because they share the same class 'accordion-collapse'
            $(document).on('shown.bs.collapse', '.accordion-collapse', function () {
                // Extract the random part of the ID from the event target
                var rand_dom = this.id.replace('collapse', '');
              
                // Focus on the corresponding PIN input
                $('#pinInput' + rand_dom).focus();

                // Scroll to the accordion header associated with the opened accordion
                $('html, body').animate({
                    scrollTop: $('#heading' + rand_dom).offset().top
                }, 500); // duration 500ms
            });

            function startCountdown(duration) {
                var timer = duration, minutes, seconds;
                var countdownInterval = setInterval(function () {
                    seconds = parseInt(timer % 60, 10);

                    seconds = seconds < 10 ? "0" + seconds : seconds;

                    $('#countdown_timer').text(seconds);

                    if (--timer < 0) {
                        timer = duration;
                    }
                }, 1000);

                return countdownInterval;
            }

            var countdown = startCountdown(30);

            reloadAllUserData();
            setInterval(function() {
                reloadAllUserData();
                // Reset countdown
                clearInterval(countdown);
                countdown = startCountdown(30);
            }, 30000);

        });

        // #### PIN Section END ####


        // Function to extract time_change details
        function parseChangeDetails(changeValue) {
            var details = changeValue.split(',');
            var minutes = parseInt(details[1], 10) / 60;
            var actionSymbol = details[0] === 'add' ? '+' : (details[0] === 'remove' ? '-' : details[0]);
            return {
                action: actionSymbol,
                minutes: parseInt(minutes, 10),
                timeframe: details[2],
                status: details[3]
            };
        }

        function get_buttons(user, computer, state = 'enabled'){

        }

        function add_or_remove_time(user, computer, action, seconds, timeframe, rand_dom, callback){
            const data = {
                'user': user,
                'computer': computer,
                'action': action,
                'seconds': seconds,
                'timeframe': timeframe,
                'status': 'pending',
                'pin': verifiedPin // backend checks PIN again in case someone manipulated "isPinverified = true" without knowing the pin
            };
            $.ajax({
                url: '/queue_time_change',
                type: 'POST',
                data: data,
                success: function(response) {
                    // Call the callback with the result message
                    if (response.result === "queued" || response.result === "success") {
                        callback('Time change ' + response.result);
                        // Call the get_database route and execute render_user_to_dom
                        $.getJSON("/get_database/" + computer + "/" + user, function(usage) {
                            render_user_to_dom(user, computer, usage, rand_dom);
                        }).fail(function() {
                            callback('Error loading data.');
                        });
                    } else if (response.result === "fail") {
                        callback('Error processing time change.');
                    }
                },
                error: function(error) {
                    // Call the callback with the error message
                    callback('Error queuing time change: ' + error.responseText);
                }
            });
        }

        function loadUserDataAndUpdateDOM(computer, user, rand_dom) {
            // Load user data
            $.getJSON("/get_database/" + computer + "/" + user, function(usage) {
                // Data has been loaded, update the DOM
                render_user_to_dom(user, computer, usage, rand_dom);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                // If there's an error loading the data, display an error message
                displayMessage('Error loading data: ' + textStatus);
            });
        }

        function displayMessage(message) {
            // Update the page with the message
            $('#messageDisplay').text(message);
        }

        // thanks https://stackoverflow.com/a/37096512 !
        function secondsToHms(d) {
            if (Number(d) === 0){
                return "none";
            }
            d = Number(d);
            var days = Math.floor(d / 86400);
            var h = Math.floor(d % 86400 / 3600);
            var m = Math.floor(d % 3600 / 60);
            var s = Math.floor(d % 60);
            var daysDisplay = days > 0 ? days + (days === 1 ? " day " : " days ") : "";
            var hDisplay = h > 0 ? h + (h === 1 ? " hr " : " hrs ") : "";
            var mDisplay = m > 0 ? m + (m === 1 ? " min " : " mins ") : "";
            var sDisplay = s > 0 ? s + (s === 1 ? " sec" : " secs") : "";
            return daysDisplay + hDisplay + mDisplay + sDisplay;
        }

        /**
         * Flip the theme back and forth between light and dark
         */
        function toggleTheme() {
          const element = document.body;
          element.classList.toggle("dark-mode");
          console.log("toggled!");
        }
        // add click handler to toggle theme
        $('#toggle_theme').click(function (){
          toggleTheme();
        })
        // thanks https://stackoverflow.com/a/59621903 !
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          // Dark
          toggleTheme();
        }

        // Activate Tab Menu
        $('#myTab a').on('click', function (e) {
          e.preventDefault()
          $(this).tab('show')
        })

       // Update User Settings
       function updateSetting(option, value) {
          $.ajax({
            url: '/update_settings',
            type: 'POST',
            data: { option: option, value: value.toString() }, // Konvertieren Sie den booleschen Wert in einen String
            success: function(response) {
              console.log('Settings updated: ', response);
            },
            error: function(error) {
              console.error('Error updating settings: ', error);
            }
          });
        }

        // #### Background Service Button START ####

        // Background Service
        var isBackgroundServiceEnabled = "{{ database['settings']['background_service'] }}" === 'true';

        // Change icons of background service
        function updateBackgroundStatusIcon() {
          var statusSpan = document.getElementById('status-background_service');
          statusSpan.innerHTML = isBackgroundServiceEnabled ? 
          '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="green" class="bi bi-check-circle" viewBox="0 0 16 16">' +
            '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>' +
            '<path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>' +
          '</svg>' :
          '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="red" class="bi bi-x-circle" viewBox="0 0 16 16">' +
            '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>' +
            '<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>' +
          '</svg>';
        }

        // Event-Handler for Background Service
        function handleAutoUpdateClick() {
          isBackgroundServiceEnabled = !isBackgroundServiceEnabled;
          // Call function updateSettings to update database.ini
          updateSetting('background_service', isBackgroundServiceEnabled ? 'true' : 'false');
          updateBackgroundStatusIcon();
        }

        function updateAutoUpdateButtonClickable() {
          var autoUpdateButton = document.getElementById('auto_update');
          if (!isPinRequired || (isPinRequired && isPinVerified)) {
            // Make the button clickable
            autoUpdateButton.style.pointerEvents = 'auto';
            autoUpdateButton.classList.remove('disabled');
            autoUpdateButton.addEventListener('click', handleAutoUpdateClick);
          } else {
            // Make the button not clickable
            autoUpdateButton.style.pointerEvents = 'none';
            autoUpdateButton.classList.add('disabled');
            autoUpdateButton.removeEventListener('click', handleAutoUpdateClick);
          }
        }

        // #### Background Service Button END ####

        // #### PIn Status Button START ####

        // Function to update the pin status icon
        function updatePinStatusIcon() {
          var pinStatusIcon = document.getElementById('pin_status_icon');
          if (!isPinRequired) {
            // If a PIN is not required, show the unlocked icon
            pinStatusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="grey" class="bi bi-unlock-fill" viewBox="0 0 16 16">' +
                                        '<path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2"/>' +
                                      '</svg>';
          } else if (isPinVerified) {
            // If a PIN is required and verified, show a different icon
            pinStatusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="red" class="bi bi-unlock-fill" viewBox="0 0 16 16">' +
                                        '<path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2"/>' +
                                      '</svg>';
          } else {
            // If a PIN is required but not verified, show a locked icon
            pinStatusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="green" class="bi bi-lock-fill" viewBox="0 0 16 16">' +
                                        '<path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/>' +
                                      '</svg>'; 
          }
        }

        // Function to handle the pin status when the label is clicked
        function handlePinStatus() {
          if (isPinRequired && isPinVerified) {
            // Reset the PIN verification status
            verifiedPin = null;
            isPinVerified = false;
            updatePinStatusIcon(); // Update the icon to reflect the new status
            updateBackgroundStatusIcon();
            updateAutoUpdateButtonClickable();

            // Show the PIN overlay and disable all buttons
            $('.pin-overlay').show();

            // Deactivate buttons
            $('.btn').not('#toggle_theme, #auto_update, #pin_status, .submit-button').addClass("disabled").prop('disabled', true);
            $('.btn-check').addClass("disabled").prop('disabled', true);
            $('.form-range').addClass("disabled").prop('disabled', true);

            $('.accordion-collapse').collapse('hide');
          } else if (isPinRequired && !isPinVerified) {
            // Open the topmost accordion item when PIN is required but not verified
            $('.accordion-collapse').first().collapse('show');
          }
          // Do nothing when PIN is not required
        }

        function updatePinStatusLabelClickable() {
          var pinStatusLabel = document.getElementById('pin_status');

          pinStatusLabel.style.pointerEvents = 'auto';
          pinStatusLabel.classList.remove('disabled');

          pinStatusLabel.addEventListener('click', handlePinStatus);
        }
       
        // #### PIn Status Button END ####

    </script>

  </body>
</html>